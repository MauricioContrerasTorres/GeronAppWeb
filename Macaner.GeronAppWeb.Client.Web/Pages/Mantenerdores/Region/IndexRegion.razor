@page "/Mantenedores/Region/IndexRegion";
@using Macaner.GeronAppWeb.Service.Interface;
@inject IRegionService _RegionService
@inject IJSRuntime jsRuntime;


@using Macaner.GeronAppWeb.Client.Web.Models;
@using Macaner.GeronAppWeb.Shared.Common
@using Macaner.GeronAppWeb.Shared.DTO
<h3>Unidades de medida</h3>

<div class="card">
    <div class="card-header">
        <div class="row">
            <div class="col-7">
                <h4 class="card-title text-dark">Lista de Unidades de Medidas</h4>
            </div>
            <div class="col-2 offset-2">
                <NavLink href="/Mantenedores/Region/AddRegion" class="btn btn-primary"><i class="fas fa-plus" style="color: #ffffff;"></i>&nbsp;Nueva Región</NavLink>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="container">
            <div class="form-group row">
                <label for="@textoBusqueda" class="col-md-1 col-form-label">Busqueda: </label>
                <div class="col-md-4">
                    <input @bind="@textoBusqueda" class="form-control col-md-4" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success" @onclick="@(()=>Buscar())"><i class="fas fa-search"></i>&nbsp;Buscar</button>
                </div>
            </div>

            <br />


            <div class="row">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (_listaUnidadesMedidas.Count() > 0)
                        {
                            foreach (var Region in _listaUnidadesMedidas)
                            {
                                <tr>
                                    <td>@Region.IdRegion</td>
                                    <td>@Region.CodigoRegion</td>
                                    <td>@Region.Nombre</td>
                                    <td>
                                        <NavLink href="@($"/Mantenedores/Region/EditRegion/{Region.IdRegion}")" class="btn btn-warning"><i class="fas fa-edit"></i>&nbsp;Editar</NavLink>
                                        <button class="btn btn-danger" @onclick="()=>Borrar(Region.IdRegion)"><i class="fas fa-trash"></i>&nbsp;Borrar</button>
                                    </td>

                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" style="text-align:center">No hay registros</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>


    </div>

</div>
<AlertConfirm CambioConfirmacion="Click_ConfirmarBorrado" mensaje="@mensaje"></AlertConfirm>

@code {
    private List<RegionDTO> _listaUnidadesMedidas = new List<RegionDTO>();

    private string textoBusqueda{ get; set; }

    private bool estaProcesando { get; set; } = false;

    private int? BorrarIdRegion { get; set; } = null;

    private string mensaje { get; set; }

    protected override async Task OnInitializedAsync(){

        var resultado = await _RegionService.GetAllAsync();       

        if (resultado.IsSuccess){
            _listaUnidadesMedidas = resultado.Data;
        }
    }

    protected async Task Borrar(int idRegion){
        BorrarIdRegion = idRegion;
        mensaje = "¿Está seguro de borrar la unidad de medida?";
        await jsRuntime.InvokeVoidAsync("ShowAlertConfirm");
    }

    protected async Task Buscar(){
        var resultado = await _RegionService.SearchAsync(textoBusqueda);

        if (resultado.IsSuccess)
        {
            _listaUnidadesMedidas = resultado.Data;
        }
    }

    protected async Task Click_ConfirmarBorrado(bool confirmado){

        estaProcesando = true;
        Response<bool> fueBorrado;

        if (confirmado && BorrarIdRegion != null){
            fueBorrado = await _RegionService.DeleteAsync(BorrarIdRegion.Value);

            if (fueBorrado.Data){
                await jsRuntime.InvokeVoidAsync("ShowSuccessAlert", "Eliminación de la Región Satisfactoria");
                await jsRuntime.InvokeVoidAsync("HideAlertConfirm");
                var response = await _RegionService.GetAllAsync();
                _listaUnidadesMedidas = response.Data;
                return;
            }            
            
        }

        await jsRuntime.InvokeVoidAsync("ShowErrorAlert", "Hubo un error con la eliminación de la región");
        await jsRuntime.InvokeVoidAsync("HideAlertConfirm");
        estaProcesando = false;
    }
}
